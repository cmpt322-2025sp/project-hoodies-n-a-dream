<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nitro Numbers</title>
    <link rel="stylesheet" href="general.css" />
    <link rel="stylesheet" href="Startscreen.css" />
    <link rel="stylesheet" href="countDown.css" />
    <link rel="stylesheet" href="answerStreak.css" />
    <link rel="stylesheet" href="Finishline.css" />
    <link rel="stylesheet" href="Finishscreen.css" />
</head>
<body>

<section data-view="startScreen" class="active StartScreen">
        <div id="buttonContainer" style="display: none; position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); text-align: center;">
            <button onclick="addition()" class="level-button">
                <img src="../assets/Easy.png" alt="Easy">
            </button>
            <button onclick="subtraction()" class="level-button">
                <img src="../assets/Medium.png" alt="Medium">
            </button>
            <button onclick="multiplication()" class="level-button">
                <img src="../assets/Hard.png" alt="Hard">
            </button>
        </div>

        <img src="../assets/NitroNumbers.png" class="title" alt="NitroNumbers"/>
        <img src ="../assets/Start.png" class = "Start" alt = "Start" onclick="Create()"/>
        <img src ="../assets/Join.png" class = "Join" alt = "Join" onclick="Code()"/>
    </section>

    <section data-view="gameAnimation">
        <div id="carShield"></div>

        <div id = "carStreak"></div>
        <div id="map1"></div>
        <div id="map2"></div>
        <div id="map3"></div>
        <div id="track"></div>

        <div id="transition">
            <img src="https://i.pinimg.com/474x/df/65/67/df6567a6fa06656d909980e6fbdcfdf1.jpg" >
            <img src="https://th.bing.com/th/id/R.602b95bb0daec842b69c42e007d79026?rik=%2bprgNhkUS1OsvA&pid=ImgRaw&r=0" >
            <img src="https://th.bing.com/th/id/R.1f4a53e7d20f061e3ac2616988fc024b?rik=Em5fLqVRGqZukQ&pid=ImgRaw&r=0" >
            <img src="https://th.bing.com/th/id/R.1f4a53e7d20f061e3ac2616988fc024b?rik=Em5fLqVRGqZukQ&pid=ImgRaw&r=0" >
            <img src="https://i.pinimg.com/474x/df/65/67/df6567a6fa06656d909980e6fbdcfdf1.jpg" >
            <img src="https://th.bing.com/th/id/R.602b95bb0daec842b69c42e007d79026?rik=%2bprgNhkUS1OsvA&pid=ImgRaw&r=0" >
            <img src="https://th.bing.com/th/id/R.1f4a53e7d20f061e3ac2616988fc024b?rik=Em5fLqVRGqZukQ&pid=ImgRaw&r=0" >
        </div>

        <div id="overlay"></div>
        <button id="startRaceButton" onclick=" sendStartGame()">Start Race</button>
        <h1 id="waiting">Waiting ...</h1>
        <img id="preRaceCarModel"  src="../Assets/Car1.png">
        <div id="countDown"></div>

        <div id="answerStreak"></div>

        <div id="room-code">Game ID: Loading...</div>
        <div>
            <img id="orangeCar" class="topCar car" src="../assets/Car1.png" alt="Car">
            <img id="purpleCar" class="middleCar car" src="../assets/PurpleCar-1.png" alt="purpleCar">
            <img id="blueCar" class="bottomCar car" src="../assets/BlueCar-4.png" alt="blueCar">
        </div>

        <div class="playersInGameContainer">
            <div id="p1_model" class="playersInGame">
                <img class="car-models" src="../Assets/Car1.png" alt="orangeCarModel">
                <h1 id="player1Name" class="player_text"> Player   1</h1>
                <img class="fireStreak" src="../assets/fireStreak5.png" alt="streak#1">
                <img class="fireStreak" src="../assets/fireStreak5.png" alt="streak#2">
                <img class="fireStreak" src="../assets/fireStreak6.png" alt="streak#3">
                <img class="fireStreak" src="../assets/fireStreak6.png" alt="streak#4">
                <img class="fireStreak" src="../assets/fireStreak3.png" alt="streak#5">
                <img class="fireStreak" src="../assets/fireStreak3.png" alt="streak#6">
            </div>
            <div id="p2_model" class="playersInGame">
                <img class="car-models" src="../assets/PurpleCar-1.png" alt="purpleCarModel">
                <h1 id="player2Name" class="player_text"> Player   2</h1>
                <img class="fireStreak" src="../assets/fireStreak5.png" alt="streak#1">
                <img class="fireStreak" src="../assets/fireStreak5.png" alt="streak#2">
                <img class="fireStreak" src="../assets/fireStreak6.png" alt="streak#3">
                <img class="fireStreak" src="../assets/fireStreak6.png" alt="streak#4">
                <img class="fireStreak" src="../assets/fireStreak3.png" alt="streak#5">
                <img class="fireStreak" src="../assets/fireStreak3.png" alt="streak#6">
            </div>
            <div id="p3_model" class="playersInGame">
                <img class="car-models" src="../assets/BlueCar-4.png" alt="blueCarModel">
                <h1 id="player3Name" class="player_text"> Player   3</h1>
                <img class="fireStreak" src="../assets/fireStreak5.png" alt="streak#1">
                <img class="fireStreak" src="../assets/fireStreak5.png" alt="streak#2">
                <img class="fireStreak" src="../assets/fireStreak6.png" alt="streak#3">
                <img class="fireStreak" src="../assets/fireStreak6.png" alt="streak#4">
                <img class="fireStreak" src="../assets/fireStreak3.png" alt="streak#5">
                <img class="fireStreak" src="../assets/fireStreak3.png" alt="streak#6">
            </div>
        </div>

        <div>
            <h1 id="clock">00:00</h1>
        </div>

        <div class="equation-container">
            <h1 id="equation"></h1>
        </div>
        <div class="button-container">
            <button id="bt1" class = "buttons" onclick="checkAnswer(this)"><span id = "bt1span"></span></button>
            <button id="bt2" class = "buttons" onclick="checkAnswer(this)"><span id = "bt2span"></span></button>
            <button id="bt3" class = "buttons" onclick="checkAnswer(this)"><span id = "bt3span"></span></button>
            <button id="bt4" class = "buttons" onclick="checkAnswer(this)"><span id = "bt4span"></span></button>
        </div>

        <div id="game-border"></div>

        <div class="traffic-light-box">
            <div id="red" class="light red"></div>
            <div id="yellow" class="light yellow"></div>
            <div id="green" class="light green"></div>
        </div>

        <audio id="countSound" src="../audio/countdown_Bell2.wav" preload="auto"></audio>
        <audio id="rightSound" src="../audio/rightSound.wav" preload="auto"></audio>
        <audio id="wrongSound" src="../audio/wrongSound2.mp3" preload="auto"></audio>
        <audio id="soundTrack" src="../audio/soundtrack.wav" preload="auto" loop></audio>
        <audio id="streakSound" src="../audio/streakSound.wav" preload="auto"></audio>

        <label>
<!--            <input id=playerCount type="number">-->
        </label>
    </section>


    <section data-view="finishLine">
        <div id="finish"></div>
        <div id="cup"></div>
        <div id="finish_track"></div>
        <div>
            <img id="finish_car" class="car1" src="../assets/Car1.png" alt="finish_car">
        </div>
    </section>


    <section data-view="finishScreen">
        <div>
            <img id = "last_car" class="carfs" src="../assets/Car1.png" alt="last_car">
        </div>
        <div class="players">
            <div class="player1">
                <img id="car1-models" src="../assets/Car1.png">
                <h1 id="player-border"> Player1</h1>
            </div>
            <h1 id="clockfs">00:00</h1>
            <div id="finishsection"></div>
        </div>
        <img src="../assets/CONGRATULATIONS.png" class="Congrats" alt="NitroNumbers"/>
        <img src ="../assets/Rematch.png" class = "Rematch" alt = "Rematch" onclick="Restart()"/>
        <img src ="../assets/Pitstop.png" class = "Quit" alt = "Quit" onclick="Pitstop()"/>

    </section>

</body>
<script>
let numberOfPlayers = 1;
let currentPlayer = 0;
</script>
<script src="Questions.js"></script>
<script src="Gamefunctions.js"></script>
<script src="Startscreen.js"></script>
<script src="FinishLine.js"></script>
<script src="Finishscreen.js"></script>
<script>

    let ws = new WebSocket("wss://math-nitro-racing.deno.dev/ws");
    let gameID = null;

    ws.onopen = () => console.log("✅ WebSocket Connected");
    ws.onmessage = (event) => {
        const response = JSON.parse(event.data);
        console.log(response);
        switch (response.type) {
            case "gameCreated":
                gameID = response.gameID;
                console.log(`Game created with ID: ${gameID}`);
                navigateTo("gameAnimation");
                // Show the buttons container after game creation
                document.getElementById('buttonContainer').style.display = 'block';
                // Update room-code display
                const roomCodeElem = document.getElementById('room-code');
                if(roomCodeElem) roomCodeElem.textContent = `Game ID: ${gameID}`;
                break;

            case "joinedGame":
                gameID = response.gameID;
                // document.getElementById("game-info").innerText = `Joined Game: ${gameID}`;
                createPlayerPositions(response);
                navigateTo("gameAnimation");
                break;

            case "playerJoined":
                logMessage(`👤 Player Joined: ${response.name}`);
                numberOfPlayers += 1;
                updatePlayerCount(response);
                break;

            case "gameStarting":
                // Lights();
                break;

            case "gameStarted":
                logMessage("🏁 The race (game) has started!");
                Lights();
                break;

            case "questions":
                // The server sent an array of question objects
                if (response.questions && response.questions.length > 0) {
                    // 1) Store them
                    currentQuestionSet = response.questions;
                    // 2) Reset index
                    currentQuestionIndex = 0;
                    // 3) Display the first question
                    displayEquation(currentQuestionSet[currentQuestionIndex]);
                }

                // Optionally, acknowledge we got them
                ws.send(JSON.stringify({
                    type: "questionsReceived",
                    gameID: gameID,
                    status: "200"
                }));
                break;

            case "scoreReport":
                logMessage(`Score Update for ${response.name}: ${response.score}`);
                updatePlayerPosition(response);
                break;

            case "gameCompleted":
                console.log("Game Completed");
                logMessage("🏆 Game Over! Results:");
                response.players.forEach(player => {
                    logMessage(` - ${player.name}: Score = ${player.score}, Time = ${player.time}`);
                });
                playersEnding(response);
                break;

            case "ERROR":
                logMessage(`❌ ERROR: ${response.message}`);
                break;

            default:
                logMessage("ℹ️ Unhandled response: " + JSON.stringify(response));
        }
    };

    function createGameAndNavigate() {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "createGame" }));
        } else {
            console.error("WebSocket not open yet.");
        }
    }

    // --- added from test.html ---
    // Simple console logger to mirror test client behaviour
    function logMessage(msg) {
        console.log(msg);
    }

    // Starts the game on the server, then immediately asks for the first batch
    // of questions at the difficulty stored in localStorage. Afterwards, it
    // invokes the existing Lights() countdown so original animations remain.
    function sendStartGame() {
        console.log("Called Start Game");
        if (!gameID) {
            logMessage("⚠️ No Game ID. Cannot start.");
            return;
        }
        logMessage("🏎️ Starting Game!");
        ws.send(JSON.stringify({
            type: "startGame",
            gameID: gameID
        }));

        const difficulty = localStorage.getItem("difficulty");
        logMessage(`➡️ Requesting questions (${difficulty}) via WebSocket`);
        /*
        ws.send(JSON.stringify({
            type: "requestNextQuestion",
            gameID: gameID,
            difficulty: difficulty
        }));
         */

        // Trigger existing race‑start visuals/countdown
        // if (typeof Lights === "function") {
        //     Lights();
        // }
    }

    let currentCorrectAnswer = null;
    function displayQuestion(questionObj) {
        // Clear old content
        const container = document.getElementById("question-container");
        container.innerHTML = "";

        // Show the question text
        const questionText = document.createElement("h3");
        questionText.innerText = questionObj.question;
        container.appendChild(questionText);

        // Prepare 4 answers
        const answers = [...questionObj.incorrect_answers, questionObj.correct_answer];
        answers.sort(() => Math.random() - 0.5);

        // Store the correct answer
        currentCorrectAnswer = questionObj.correct_answer;

        // Create a button for each possible answer
        answers.forEach(answer => {
            const btn = document.createElement("button");
            btn.className = "answer-button";
            btn.innerText = answer;
            btn.onclick = () => {
                checkAnswer(questionObj.id, answer);
            };
            container.appendChild(btn);
        });
    }

    // 8) Check the selected answer
    /*
    function checkAnswer(questionID, chosenAnswer) {
        const isCorrect = (chosenAnswer === currentCorrectAnswer);
        logMessage(isCorrect ? "✅ Correct!" : "❌ Wrong!");

        const points = isCorrect ? 10 : 0;
        ws.send(JSON.stringify({
            type: "scoreUpdate",
            gameID: gameID,
            score: points,
            attempts: 1,
            questionID: questionID
        }));

        // Move to the next question, if any exist
        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestionSet.length) {
                displayQuestion(currentQuestionSet[currentQuestionIndex]);
            } else {
                logMessage("🎉 You’ve reached the end of the question set!");
                // Optionally do something else: end game, show final results, etc.
            }
        }, 800);
    }
     */
</script>
<!--<script src="Gamefunctions.js"></script>-->
<!--<script src="Startscreen.js"></script>-->
<!--<script src="Questions.js"></script>-->
<!--&lt;!&ndash;<script src="FinishLine.js"></script>&ndash;&gt;-->
<!--<script src="Finishscreen.js"></script>-->


<script>
    function navigateTo(viewName) {
        // hide every view
        document.querySelectorAll('[data-view]').forEach(sec => {
            sec.classList.remove('active');
        });

        // show the one we want
        const target = document.querySelector(`[data-view="${viewName}"]`);
        if (target) target.classList.add('active');
        if (viewName === 'finishLine') {
            finish();
        }
        else if (!target) console.warn(`No view found for "${viewName}"`);
    }

</script>


</html>